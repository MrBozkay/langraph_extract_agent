version: '3.8'

services:
  # Extraction Pipeline Application (Production)
  extraction-app:
    build: .
    container_name: extraction-pipeline-prod
    environment:
      # MinIO Configuration (from .env file)
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      - MINIO_SECURE=${MINIO_SECURE}
      # LLM Configuration
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LANGEXTRACT_MODEL=${LANGEXTRACT_MODEL}
      # Extraction Settings
      - EXTRACTION_BATCH_SIZE=${EXTRACTION_BATCH_SIZE}
      - EXTRACTION_RETRY_COUNT=${EXTRACTION_RETRY_COUNT}
      - EXTRACTION_RETRY_DELAY=${EXTRACTION_RETRY_DELAY}
      - EXTRACTION_TIMEOUT=${EXTRACTION_TIMEOUT}
      - EXTRACTION_MAX_WORKERS=${EXTRACTION_MAX_WORKERS}
      # Rate Limiting
      - RATE_LIMIT_REQUESTS_PER_MINUTE=${RATE_LIMIT_REQUESTS_PER_MINUTE}
      - RATE_LIMIT_DELAY_BETWEEN_REQUESTS=${RATE_LIMIT_DELAY_BETWEEN_REQUESTS}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FILE=${LOG_FILE}
    env_file:
      - .env
    volumes:
      - ./src:/app/src
      - ./logs:/app/logs
    # Use production runner by default
    command: python src/agents/run_batch_production.py
    restart: unless-stopped
    networks:
      - extraction-network

  # Optional: Local MinIO for testing (commented out for production)
  # minio:
  #   image: minio/minio:latest
  #   container_name: extraction-minio-local
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   volumes:
  #     - minio-data:/data
  #   command: server /data --console-address ":9001"
  #   networks:
  #     - extraction-network

volumes:
  minio-data:
    driver: local

networks:
  extraction-network:
    driver: bridge
